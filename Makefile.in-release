#
# Makefile for IBR-DTN
#
# @author Johannes Morgenroth <morgenro@ibr.cs.tu-bs.de>
#

prefix=@prefix@
exec_prefix=@exec_prefix@

# SVN Version
SVNDEF := -D'SVN_REV="$(shell cat REVISION)"'

# 64bit fix
CFLAGS += -fPIC -O3 $(SVNDEF)

# api sources
API_OBJ := $(patsubst %.cpp,%.o, $(wildcard @srcdir@/src/api/*.cpp))
API_BUILD_OBJ := $(patsubst @srcdir@/src/%, @builddir@/obj/%, $(patsubst src/%, obj/%, $(API_OBJ) ) )

# utils sources
UTILS_OBJ := $(patsubst %.cpp,%.o, $(wildcard @srcdir@/src/utils/*.cpp))
UTILS_BUILD_OBJ := $(patsubst @srcdir@/src/%, @builddir@/obj/%, $(patsubst src/%, obj/%, $(UTILS_OBJ) ) )

# data sources
DATA_OBJ := $(patsubst %.cpp,%.o,$(wildcard @srcdir@/src/data/*.cpp))
DATA_BUILD_OBJ := $(patsubst @srcdir@/src/%, @builddir@/obj/%, $(patsubst src/%, obj/%, $(DATA_OBJ) ) )

# streams sources
STREAMS_OBJ := $(patsubst %.cpp,%.o,$(wildcard @srcdir@/src/streams/*.cpp))
STREAMS_BUILD_OBJ := $(patsubst @srcdir@/src/%, @builddir@/obj/%, $(patsubst src/%, obj/%, $(STREAMS_OBJ) ) )

# core sources
CORE_OBJ := $(patsubst %.cpp,%.o,$(wildcard @srcdir@/src/core/*.cpp))
CORE_BUILD_OBJ := $(patsubst @srcdir@/src/%, @builddir@/obj/%, $(patsubst src/%, obj/%, $(CORE_OBJ) ) )

# net sources
NET_OBJ := $(patsubst %.cpp,%.o,$(wildcard @srcdir@/src/net/*.cpp))
NET_BUILD_OBJ := $(patsubst @srcdir@/src/%, @builddir@/obj/%, $(patsubst src/%, obj/%, $(NET_OBJ) ) )

# daemon sources
DAEMON_OBJ := $(patsubst %.cpp,%.o,$(wildcard @srcdir@/src/daemon/*.cpp))
DAEMON_BUILD_OBJ := $(patsubst @srcdir@/src/%, @builddir@/obj/%, $(patsubst src/%, obj/%, $(DAEMON_OBJ) ) )

# Main target
all: dtnd tools iptunnel

tools: dtnping dtnsend dtnrecv dtninbox dtnoutbox

osx: dtnd cdtnping_sync cdtnping_async

# build directory
BUILD_DIRS := 	@builddir@/bin \
				@builddir@/lib \
				@builddir@/obj \
				@builddir@/obj/apps \
				@builddir@/obj/api \
				@builddir@/obj/streams \
				@builddir@/obj/utils \
				@builddir@/obj/data \
				@builddir@/obj/core \
				@builddir@/obj/net \
				@builddir@/obj/daemon \
				@builddir@/obj/apps/c_api_examples \
				@builddir@/obj/apps/DTNTun

# create a build directory
builddirs:
	mkdir -p $(BUILD_DIRS)
	
libdata: builddirs $(UTILS_BUILD_OBJ) $(DATA_BUILD_OBJ) $(STREAMS_BUILD_OBJ)
	$(CXX) $(CFLAGS) -I@srcdir@/include $(LDFLAGS) @LIBS@ \
		-L@builddir@/lib/ \
		-shared \
		$(UTILS_BUILD_OBJ) $(DATA_BUILD_OBJ) $(STREAMS_BUILD_OBJ) \
		-o "@builddir@/lib/libibrdtn-data.so"

libclient: libdata $(API_BUILD_OBJ)
	$(CXX) $(CFLAGS) -I@srcdir@/include $(LDFLAGS) @LIBS@ \
		-L@builddir@/lib/ \
		-shared \
		$(API_BUILD_OBJ) $(UTILS_BUILD_OBJ) $(DATA_BUILD_OBJ) $(STREAMS_BUILD_OBJ) \
		-o "@builddir@/lib/libibrdtn-client.so"

dtnping: libdata libclient @builddir@/obj/apps/dtnping.o
	$(CXX) $(CFLAGS) -I@srcdir@/include $(LDFLAGS) @LIBS@ \
		-L@builddir@/lib/ \
		-librdtn-data -librdtn-client \
		$(API_BUILD_OBJ) @builddir@/obj/apps/dtnping.o \
		-Wl,-rpath,@libdir@:@builddir@/lib \
		-o "@builddir@/bin/dtnping"

dtnsend: libdata libclient @builddir@/obj/apps/dtnsend.o
	$(CXX) $(CFLAGS) -I@srcdir@/include $(LDFLAGS) @LIBS@ \
		-L@builddir@/lib/ \
		-librdtn-data -librdtn-client \
		$(API_BUILD_OBJ) @builddir@/obj/apps/dtnsend.o \
		-Wl,-rpath,@libdir@:@builddir@/lib \
		-o "@builddir@/bin/dtnsend"

dtnrecv: libdata libclient @builddir@/obj/apps/dtnrecv.o
	$(CXX) $(CFLAGS) -I@srcdir@/include $(LDFLAGS) @LIBS@ \
		-L@builddir@/lib/ \
		-librdtn-data -librdtn-client \
		$(API_BUILD_OBJ) @builddir@/obj/apps/dtnrecv.o \
		-Wl,-rpath,@libdir@:@builddir@/lib \
		-o "@builddir@/bin/dtnrecv"

dtninbox: libdata libclient @builddir@/obj/apps/dtninbox.o
	$(CXX) $(CFLAGS) -I@srcdir@/include $(LDFLAGS) @LIBS@ \
		-L@builddir@/lib/ \
		-librdtn-data -librdtn-client \
		$(API_BUILD_OBJ) @builddir@/obj/apps/dtninbox.o \
		-Wl,-rpath,@libdir@:@builddir@/lib \
		-o "@builddir@/bin/dtninbox"
		
dtnoutbox: libdata libclient @builddir@/obj/apps/dtnoutbox.o
	$(CXX) $(CFLAGS) -I@srcdir@/include $(LDFLAGS) @LIBS@ \
		-L@builddir@/lib/ \
		-librdtn-data -librdtn-client \
		$(API_BUILD_OBJ) @builddir@/obj/apps/dtnoutbox.o \
		-Wl,-rpath,@libdir@:@builddir@/lib \
		-o "@builddir@/bin/dtnoutbox"

cdtnping_sync: libdata libclient 
	$(CC) -c $(CFLAGS) -I@srcdir@/include $(LDFLAGS) \
		-o @builddir@/obj/apps/c_api_examples/cdtnping_sync.o \
		@srcdir@/src/apps/c_api_examples/dtnping_sync.c
	$(CC) $(CFLAGS) -I@srcdir@/include $(LDFLAGS) -lpthread   \
		-L@builddir@/lib/ \
		-librdtn-data -librdtn-client \
		@builddir@/obj/apps/c_api_examples/cdtnping_sync.o \
		-Wl,-rpath,${exec_prefix}/lib:@builddir@/lib \
		-o "@builddir@/bin/cdtnping_sync"
	

cdtnping_async: libdata libclient 
	$(CC) -c $(CFLAGS) -I@srcdir@/include $(LDFLAGS) \
		-o @builddir@/obj/apps/c_api_examples/cdtnping_async.o \
		@srcdir@/src/apps/c_api_examples/dtnping_async.c
	$(CC) $(CFLAGS) -I@srcdir@/include $(LDFLAGS) -lpthread   \
		-L@builddir@/lib/ \
		-librdtn-data -librdtn-client \
		@builddir@/obj/apps/c_api_examples/cdtnping_async.o \
		-Wl,-rpath,${exec_prefix}/lib:@builddir@/lib \
		-o "@builddir@/bin/cdtnping_async"

dtntun: libdata libclient 
	$(CC) -c $(CFLAGS) -I@srcdir@/include $(LDFLAGS) \
		-o @builddir@/obj/apps/DTNTun/dtntun.o \
		@srcdir@/src/apps/DTNTun/dtntun.c
	$(CC) -c $(CFLAGS) -I@srcdir@/include $(LDFLAGS) \
		-o @builddir@/obj/apps/DTNTun/receiver.o \
		@srcdir@/src/apps/DTNTun/receiver.c
	$(CC) -c $(CFLAGS) -I@srcdir@/include $(LDFLAGS) \
		-o @builddir@/obj/apps/DTNTun/tun.o \
		@srcdir@/src/apps/DTNTun/tun.c
	$(CC) $(CFLAGS) -I@srcdir@/include $(LDFLAGS) -lpthread -lrt  \
		-L@builddir@/lib/ \
		-librdtn-data -librdtn-client \
		@builddir@/obj/apps/DTNTun/dtntun.o \
		@builddir@/obj/apps/DTNTun/receiver.o \
		@builddir@/obj/apps/DTNTun/tun.o \
		-Wl,-rpath,${exec_prefix}/lib:@builddir@/lib \
		-o "@builddir@/bin/dtntun"

iptunnel: libdata libclient @builddir@/obj/apps/iptunnel.o
	$(CXX) $(CFLAGS) -I@srcdir@/include $(LDFLAGS) @LIBS@ \
		-L@builddir@/lib/ \
		-librdtn-data -librdtn-client \
		$(API_BUILD_OBJ) @builddir@/obj/apps/iptunnel.o \
		-Wl,-rpath,@libdir@:@builddir@/lib \
		-o "@builddir@/bin/iptunnel"

dtnd: libdata $(NET_BUILD_OBJ) $(CORE_BUILD_OBJ) $(DAEMON_BUILD_OBJ)
	$(CXX) $(CFLAGS) -I@srcdir@/include $(LDFLAGS) @LIBS@ \
		-L@builddir@/lib/ \
		-librdtn-data \
		$(NET_BUILD_OBJ) $(CORE_BUILD_OBJ) $(DAEMON_BUILD_OBJ) \
		-Wl,-rpath,@libdir@:@builddir@/lib \
		-o "@builddir@/bin/dtnd"
	
@builddir@/obj/%.o: @srcdir@/src/%.cpp
	$(CXX) -c $(CFLAGS) -I@srcdir@/include $(LDFLAGS) $< -o $@

clean:
	rm -rf @builddir@/obj
	rm -rf @builddir@/lib
	rm -rf @builddir@/bin

distclean: clean
	rm -rf Makefile
	rm -rf include/ibrdtn/config.h

selftest: testsuite
	LD_LIBRARY_PATH=@builddir@/lib @builddir@/bin/testsuite

install: install-lib install-tools
	cp @builddir@/bin/dtnd @prefix@/bin
	cp @builddir@/bin/iptunnel @prefix@/bin/dtntunnel
	
install-tools:
	cp @builddir@/bin/dtnping @prefix@/bin
	cp @builddir@/bin/dtnsend @prefix@/bin
	cp @builddir@/bin/dtnrecv @prefix@/bin
	cp @builddir@/bin/dtninbox @prefix@/bin
	cp @builddir@/bin/dtnoutbox @prefix@/bin
	
uninstall:
	rm -rf @prefix@/bin/dtnd
	rm -rf @prefix@/bin/dtnping
	rm -rf @libdir@/libibrdtn-*.so
	rm -rf @includedir@/ibrdtn
	
install-lib:
	cp @builddir@/lib/*.so @libdir@
	chmod 755 @libdir@/libibrdtn-*.so

install-dev: install-lib
	mkdir -p @includedir@/ibrdtn
	cp -R @srcdir@/include/ibrdtn/api @includedir@/ibrdtn/api
	cp -R @srcdir@/include/ibrdtn/data @includedir@/ibrdtn/data
	cp -R @srcdir@/include/ibrdtn/streams @includedir@/ibrdtn/streams
	cp -R @srcdir@/include/ibrdtn/utils @includedir@/ibrdtn/utils
	cp @srcdir@/include/ibrdtn/config.h @includedir@/ibrdtn
	cp @srcdir@/include/ibrdtn/default.h @includedir@/ibrdtn

	
